"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.validator = validator;
exports.isValidator = isValidator;
const string_utils_js_1 = require("../helpers/string.utils.js");
const constants_js_1 = require("./constants.js");
const context_js_1 = require("./context.js");
const validation_error_js_1 = require("./validation-error.js");
let unnamedValidatorIndex = 0;
function validator(arg0, arg1, arg2) {
    let id = '';
    let fn;
    let validatorOptions;
    if (typeof arg0 === 'string') {
        id = arg0;
        fn = arg1;
        validatorOptions = arg2;
    }
    else {
        fn = arg0;
        validatorOptions = arg1;
    }
    if (typeof fn !== 'function') {
        throw new TypeError('You must provide a rule function argument');
    }
    id = id || fn.name || 'validator' + ++unnamedValidatorIndex;
    const name = fn.name || (0, string_utils_js_1.camelCase)(id);
    const _rule = {
        [name](input, options, context) {
            if (context) {
                if (options || validatorOptions)
                    context = context.extend({ ...validatorOptions, ...options });
            }
            else {
                context =
                    options instanceof context_js_1.Context
                        ? options.extend({ ...validatorOptions })
                        : new context_js_1.Context({ ...validatorOptions, ...options });
            }
            let value;
            try {
                value = fn(input, context, _rule);
            }
            catch (e) {
                if (e instanceof validation_error_js_1.ValidationError)
                    throw e;
                context.fail(_rule, e, input);
            }
            if (context.isRoot && context.errors.length) {
                throw new validation_error_js_1.ValidationError(context.errors);
            }
            return value;
        },
    }[name];
    _rule.id = id;
    _rule[constants_js_1.kValidatorFn] = fn;
    _rule[constants_js_1.kOptions] = validatorOptions || {};
    _rule.silent = (input, options, context) => {
        try {
            const value = _rule(input, options, context);
            return { value };
        }
        catch (e) {
            return { errors: e.issues };
        }
    };
    return _rule;
}
function isValidator(x) {
    return !!(typeof x === 'function' && x.id && x[constants_js_1.kValidatorFn]);
}
